/* Backtree. Copyright 2013. Tim Child, All Rights Reserved.
 * For source and license please see http://github.com/timc3/backtree/ - Released under Creative Commons Attribution-ShareAlike 3.0 Unported License
 */
(function(a,b,c,d){var f=a.Backtree={VERSION:"0.0.3",isMobile:/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent)},g=f.EventCoordinator=function(a){this._configure(a||{})};c.extend(g.prototype,{_configure:function(a){this.options&&(a=c.extend({},c.result(this,"options"),a)),this.options=a,this.pubfunction=a.publist||b.publish||void 0,this.subfunction=a.subscribe||b.subscribe||void 0,this.unsubfunction=a.unsubscribe||b.unsubscribe||void 0,this.topicPrefix=a.topicPrefix||"/bt/"},publish:function(a,b,c){void 0!==c&&c.trigger(a,b),this.pubfunction(this.topicPrefix+a,[b,c])},subscribe:function(a,b){void 0!==this.subfunction&&this.subfunction(this.topicPrefix+a,b)},unsubscribe:function(a,b){void 0!==this.unsubfunction&&this.unsubfunction(this.topicPrefix+a,b)}}),f.View=d.View.extend({topicCache:{},eventCoordinator:"",constructor:function(){var a=Array.prototype.slice.apply(arguments);d.View.prototype.constructor.apply(this,a)},eventPublish:function(a,b,c){this.eventCoordinator.publish(a,b,c)},eventSubscribe:function(a,b){this.eventCoordinator.subscribe(a,b),this.topicCache[a]=b},eventUnSubscribe:function(a,b){delete this.topicCache[a],this.eventCoordinator.unsubscribe(a,b)},eventClearAll:function(){var a=this;c.each(this.topicCache,function(b){a.eventUnSubscribe(b.event,b.callback)})}}),f.FooterView=f.View.extend({tagName:"footer",template:c.template('    <nav class="right">    <ul class="menu">    <li><a href="#" class="bt-ft-add-button">Add</a></li>    <li><a href="#" class="bt-ft-remove-button">Remove</a></li></ul>    </nav>    '),constructor:function(){c.bindAll(this,"render","enable","disable");var a=Array.prototype.slice.apply(arguments);f.View.prototype.constructor.apply(this,a)},events:function(){return f.isMobile?{"touchstart .bt-ft-add-button":"addCollection","touchstart .bt-menu-active .bt-ft-remove-button":"removeCollection"}:{"click .bt-ft-add-button":"addCollection","click .bt-menu-active .bt-ft-remove-button":"removeCollection"}},render:function(){return this.$el.html(this.template()),this},enable:function(){this.$(".menu").addClass("bt-menu-active")},disable:function(){this.$(".menu").removeClass("bt-menu-active")},addCollection:function(){this.$el.trigger("add-new-collection")},removeCollection:function(){this.$el.trigger("remove-selected-collection")}}),f.TreeView=f.View.extend({tagName:"div",selectedCollection:[],constructor:function(){c.bindAll(this,"render","addNew"),this.children=new d.ChildViewContainer;var a=Array.prototype.slice.apply(arguments);f.View.prototype.constructor.apply(this,a),this._initialEvents()},_initialEvents:function(){this.collection&&(this.listenTo(this.collection,"add",this.addChildView,this),this.listenTo(this.collection,"remove",this.removeNodeView,this),this.listenTo(this.collection,"reset",this.render,this),this.listenTo(this.collection,"change:contents",this.updateChildView,this))},events:{"remove-selected-collection":"removeSelected","add-new-collection":"addNew"},initialize:function(a){this.selectedCollection=[],this.className=a.className||"backtree",this.stateAttribute=a.stateAttribute||"state",this.branchAttribute=a.branchAttribute||"contents",this.nameAttribute=a.branchAttribute||"name",this.collection=a.collection,this.childTemplateRenderer=a.childTemplateRenderer||void 0,this.topicPrefix=a.topicPrefix||"/backtree/",this.eventCoordinator=a.eventCoordinator||new f.EventCoordinator({topicPrefix:this.topicPrefix}),this.footer=a.footer||new f.FooterView,this.tree=a.tree||b('<div class="bt-wrapper"><nav class="tree"></div>'),this.header=a.header||b("<header>"),this._renderStructure(),this._selectedEventBinder(),void 0!==a.el&&this.render()},_selectedEventBinder:function(){var a=this;this.eventSubscribe("unselected",function(b){a.selectedCollection=c.reject(a.selectedCollection,function(a){return a.view.cid==b.view.cid?a:void 0}),0===a.selectedCollection.length&&a.footer.hasOwnProperty("disable")&&a.footer.disable()}),this.eventSubscribe("selected",function(b,c){a.selectedCollection.push({view:b.view,collection:c}),a.selectedCollection.length>0&&a.footer.hasOwnProperty("enable")&&a.footer.enable()})},_renderStructure:function(){var a=this,c=function(c){return c.hasOwnProperty("render")?(c.render(),c.$el.appendTo(a.$el)):b(c).appendTo(a.$el)};this.$el.empty().addClass(this.className),this.$headerEl=c(this.header),this.$treeEl=c(this.tree),this.$footerEl=c(this.footer)},render:function(){return this.collection&&this.collection.length>0&&this.buildCollectionView(),this.trigger("rendered"),this},buildCollectionView:function(){var a=this;this.collection.each(function(b,c){a.addNodeView(b,f.NodeView,c)})},addNew:function(){var b=this.selectedCollection,c={type:"collection",name:"Untitled",state:"closed"},e={};if(e[this.branchAttribute]=[c],0==b.length)this.collection.add(c);else{var g=b[0];if(g.view.unselect(),g.hasOwnProperty("children")||(g.children=new d.ChildViewContainer),g.collection.hasOwnProperty(this.branchAttribute))var h=g.collection[this.branchAttribute].add(c);else{var h=g.collection.set(e);g.view.collection=h.contents,g.view._initialEvents(),g.view.addNodeView(h.contents.at(0),f.NodeView)}}},updateChildView:function(a){var d=this,e=this.children.findByModel(a);void 0!==a[d.branchAttribute]&&(void 0===e.collection&&(e.collection=a[d.branchAttribute],e._initialEvents()),e.render())},addChildView:function(a){var d=this.collection.indexOf(a);this.addNodeView(a,f.NodeView,d)},addNodeView:function(a,b,c){var d=new b({model:a,parentView:this,branchAttribute:this.branchAttribute,templateRenderer:this.childTemplateRenderer,eventCoordinator:this.eventCoordinator,topicPrefix:this.topicPrefix});this.children.add(d),d.render(),this.appendHTML(this,d,c)},appendHTML:function(a,b){a.$treeEl.append(b.el)},removeNodeView:function(a){var b=this.children.findByModel(a);void 0!==this.selectedCollection[0]&&this.selectedCollection[0].collection.cid===a.cid&&(this.selectedCollection.pop(0),this.footer.disable()),this.removeChildView(b)},removeSelected:function(){void 0!==this.selectedCollection[0]&&this.selectedCollection[0].hasOwnProperty("collection")&&this.selectedCollection[0].view.model.destroy()},removeChildView:function(a){a&&(a.close&&a.close(),this.children.remove(a))},close:function(){this.eventClearAll(),this.closeChildren(),this.remove()},closeChildren:function(){this.children.each(function(a){this.removeChildView(a)},this)}}),f.NodeView=f.TreeView.extend({tagName:"ul",template:c.template('<li><div class="bt-node">      <div class="bt-arrow <% if (state != undefined && state === "open"){ %>bt-arrow-open<% } %>">      </div><div class="bt-icon bt-icon-<%= type %>">      </div><span class="contenteditable"><%= name||id %></span></div></li>'),events:function(){return f.isMobile?{"touchstart .bt-node":"select","touchstart .bt-arrow":"toggleVisibility"}:{"click .bt-node":"select","click .bt-arrow":"toggleVisibility","click .contenteditable":"editname"}},constructor:function(){c.bindAll(this,"render","selectEventHandler");var b=Array.prototype.slice.apply(arguments);f.TreeView.apply(this,b)},initialize:function(a){this.templateRenderer=a.templateRenderer,this.collection=this.model[a.branchAttribute],this.eventCoordinator=a.eventCoordinator||new f.EventCoordinator,this.listenTo(this.model,"select",function(){this.select()},this)},render:function(){var b=this.returnRendered();return this.$el.addClass("bt-branch").html(b).attr("data-id",this.model.cid),this.renderCollection(),this},renderCollection:function(){var a=Array.prototype.slice.apply(arguments);f.TreeView.prototype.render.apply(this,a)},returnRendered:function(){void 0===this.model.get("state")&&this.model.set({state:"closed"});var a="";return a=void 0!==this.templateRenderer?this.templateRenderer(this.model,this):this.template(this.model.attributes)},appendHTML:function(a,b){a.$("li:first").append(b.el).find("div.bt-arrow:first").addClass("bt-arrow-open").end().find("div.bt-icon:first").addClass("bt-icon-collection-open")},select:function(a){void 0!==a&&(a.preventDefault(),a.stopPropagation());var c=this.$(".bt-node:first").toggleClass("bt-node-selected").hasClass("bt-node-selected");this.eventPublish(c?"selected":"unselected",{view:this},this.model),c===!0?this.eventSubscribe("selected",this.selectEventHandler):this.eventUnSubscribe("selected",this.selectEventHandler)},unselect:function(){this.$(".bt-node:first").removeClass("bt-node-selected"),this.eventUnSubscribe("selected",this.selectEventHandler),this.eventPublish("unselected",{view:this},this.model)},selectEventHandler:function(){this.eventUnSubscribe("selected",this.selectEventHandler),this.unselect()},editname:function(a){a.preventDefault(),a.stopPropagation();var c=a.target||a.srcElement,d=this,e=c.innerHTML,f=document.createElement("input");c.style.display="none",f.type="text",f.value=e,c.parentNode.insertBefore(f,c),f.focus(),b(f).keydown(function(a){27==a.which?(f.onblur=null,c.parentNode.removeChild(f),c.style.display=""):13==a.which&&f.blur()}),f.onblur=function(){c.innerHTML=f.value,d.model.set({name:f.value}),c.parentNode.removeChild(f),c.style.display=""}},toggleVisibility:function(a){void 0!==a&&(a.preventDefault(),a.stopPropagation());var b=this.$el.toggleClass("bt-node-closed").hasClass("bt-node-closed");return this.eventPublish(b?"hidden":"visible",{view:this},this.model),!0}})})(this,$,_,Backbone);
